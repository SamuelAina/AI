<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPRA Issues App</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="issues.css"/>
</head>
<body class="container">
	<header class="page-header">
		<div class="container">
			<!-- <a href="#"><img src="logo.png" alt="App Logo" class="logo" ></a> -->
			<h1 class="app-title">GPRA Issues App</h1><h8></h8>
		</div>
	</header>
<div class="div-group">
    <div>
        <b>Country:</b><div id="dvCountry"></div>
    </div>
    <div class="div-group-right">
        <b>Date range:</b><div id="dvDaterange" onclick="filtersChanged()">
            <select id="selDateRange" name="selDateRange">
                <option>In the past day</option>
                <option>In the past week</option>
                <option>In the past month</option>
                <option>In the past year</option>
                <option>Specific date range</option>
            </select>
        </div>
    </div>
    <div id="dvstartdate"   class="div-group-right">Start Date:<div><input id="specificstartdate" title="x" placeholder="x" type="date" onchange="filtersChanged()"/></div></div>
    <div id="dvenddate"     class="div-group-right">End Date:<div><input id="specificenddate" title="x" placeholder="x"  type="date" onchange="filtersChanged()"/></div></div>
    <div id="dvgetarticles" class="div-group-right">.<div><button id="btndvgetarticles"  onclick="btndvgetarticlesClicked()">Get day articles</button></div></div>

    <div class="div-group-justfy-right">
        <button id="btnarticles" class="stylish-button" onclick="view_changed('articles')">Articles</button>
        <button id="btnissues" class="stylish-button" onclick="view_changed('issues')">Issues</button>       
    </div>
</div>
<div id="pleaseWaitMessage">Please wait...</div>


<h6>Domains</h6>
<div class="checkbox-group">
    <div class="checkbox-container political">   
        <input type="checkbox" id="political" name="domain" value="Political" onclick="checkboxClicked('Political');">
        <label for="political">Political</label>
    </div>

    <div class="checkbox-container social">
    <input type="checkbox" id="social" name="domain" value="Social" onclick="checkboxClicked('Social');">
    <label for="social">Social</label>
</div>

    <div class="checkbox-container geoeconomics">
    <input type="checkbox" id="geoeconomics" name="domain" value="Geoeconomics" onclick="checkboxClicked('Geoeconomics');">
    <label for="geoeconomics">Geoeconomics</label>
</div>

    <div class="checkbox-container technology">
    <input type="checkbox" id="technology" name="domain" value="Technology" onclick="checkboxClicked('Technology');">
    <label for="technology">Technology</label>
</div>

    <div class="checkbox-container environmental">
    <input type="checkbox" id="environmental" name="domain" value="Environmental" onclick="checkboxClicked('Environmental');">
    <label for="environmental">Environmental</label>
</div>

    <div class="checkbox-container others">
    <input type="checkbox" id="other" name="domain" value="Others" onclick="checkboxClicked('Others');">
    <label for="other">Others</label>
</div>
</div>

<div class="panel-container">
    <div id="dvArticleList"></div>
</div>
<script>
    var current_view ="articles";
    document.getElementById('dvstartdate').style.display = 'none';
    document.getElementById('dvenddate').style.display = 'none';
    document.getElementById('dvgetarticles').style.display = 'none';
    getCountryList();
    function getCountryList(mydata){
        fetch("http://127.0.0.1:8080/getCountryList", {
        method: "POST",
        headers: {'Content-Type': 'application/json'}, 
        body:JSON.stringify(mydata)
        }).then(response => {
                return response.text();
        }).then(result =>{
            //------------------------------------------
                sel_data=JSON.parse(result);
                country_sel_html=sel_data.map(function(itm){ return `<option>${itm}</option>`}).join("")
                
                document.getElementById("dvCountry").innerHTML 
                = `<select id="selCountry" onclick="filtersChanged()">${country_sel_html}</select>`;
            //-------------------------------------------
        });
    }  
    
    function getFilterValues(){
        countryElement=document.getElementById('selCountry');
        country=countryElement.options[countryElement.selectedIndex].text;

        daterangeElement=document.getElementById('selDateRange');
        daterange=daterangeElement.options[daterangeElement.selectedIndex].text;

        var checkedCheckboxes = document.querySelectorAll('input[name="domain"]:checked');
        var domainvalues = [];
        checkedCheckboxes.forEach(function(checkbox) {
            domainvalues.push(checkbox.value);
        });

        specificstartdate=document.getElementById('specificstartdate').value;
        specificenddate=document.getElementById('specificenddate').value;
    
        filterData={
            Country:country, 
            DateRange:daterange, 
            Domain:domainvalues,
            SpecificStartDate:specificstartdate,
            SpecificEndDate:specificenddate,
            CurrentView:current_view
        };

        return filterData
    }

    function filtersChanged(){
        filterData=getFilterValues();
        document.getElementById('dvstartdate').style.display = 'none';
        document.getElementById('dvenddate').style.display = 'none';
        document.getElementById('dvgetarticles').style.display = 'none';

        if(filterData.DateRange=="Specific date range"){
            document.getElementById('dvstartdate').style.display = 'block';
            document.getElementById('dvenddate').style.display = 'block';   
        }

        if (!(filterData.SpecificStartDate==""  ||  filterData.SpecificEndDate =="")){
            if(filterData.SpecificStartDate==filterData.SpecificEndDate){
                document.getElementById('dvgetarticles').style.display = 'block';        
            }            
        }
        getArticles(filterData);        
    }

    function checkboxClicked(val){
        filtersChanged()
    }

    function getArticles(mydata){
        console.log("mydata",mydata)
        fetch("http://127.0.0.1:8080/getArticles", {
        method: "POST",
        headers: {'Content-Type': 'application/json'}, 
        body:JSON.stringify(mydata)
        }).then(response => {
                return response.text();
        }).then(result =>{
            //------------------------------------------
            //Get articles
            document.getElementById("dvArticleList").innerHTML="";
            if (current_view=="articles"){
                article_list=JSON.parse(result);
                article_list_html=article_list.map(function(itm){ 
                return `<div class="panel ${itm[4]}">
                            <button class="close-button" onclick="this.parentElement.style.display='none';" style="position: absolute; top: 0; right: 0; cursor: pointer;">X</button>
                            <b>Title: ${itm[0]}</b> (${itm[1]})<br/>
                            ${itm[2]}<br/>
                            <b>URL: </b><a href="${itm[3]}" target="_blank">${itm[3]}</a>
                            <button class="btn-bottom-right" onclick="getIssues(${itm[5]})">Get issue</button>
                        </div>`}).join("")
                document.getElementById("dvArticleList").innerHTML
                =`<font>Number of articles found: ${article_list.length}</font>`+article_list_html                
            }
            //-------------------------------------------
            //Get issues
            if (current_view=="issues"){
                issues_list=JSON.parse(result);
                issues_html=
                issues_list.map(
                    function(issue){
                        OOCRelevanceAndImportance= JSON.parse(issue[0]).OverallOrganisationConsiderationRelevanceAndImportance;
                        return `<div class="panel issue-panel-pack-color ${issue[1]}">
                                  <span class="badge ${assignBadgeLabel(OOCRelevanceAndImportance.replace("%",""))}">${JSON.parse(issue[0]).OverallOrganisationConsiderationRelevanceAndImportance}</span>
                                   <b>${JSON.parse(issue[0]).OverAllOrganisationVeryBriefTitleOftheIssue}:</b>
                                   ${JSON.parse(issue[0]).OverAllOrganisationVeryBriefSummaryOftheIssue}<br/>
                                   Relevance and importance percentage:${JSON.parse(issue[0]).OverallOrganisationConsiderationRelevanceAndImportance}.
                                   ${JSON.parse(issue[0]).OverallOrganisationConsiderationRationale}<br/>
                                </div>`
                    }
                ).join("");

                document.getElementById("dvArticleList").innerHTML=
                `<font>Number of issues found: ${issues_list.length}</font>`
                +issues_html;
            }
            //-------------------------------------------

            //-------------------------------------------
        });
    }

    function view_changed(cv){
        current_view =cv;


        if (current_view=="articles"){
            document.getElementById('btnissues').style.border = '0px';
            document.getElementById('btnarticles').style.border = '4px solid red';
        }else{
            document.getElementById('btnissues').style.border = '4px solid red';
            document.getElementById('btnarticles').style.border = '0px';
        }
        filtersChanged();
        console.log(current_view);
        

    }

    function prepareForShowMessage(){
        document.getElementById('pleaseWaitMessage').style.display = 'block'; // Show the message
        document.getElementById('btndvgetarticles').disabled = true;
        document.getElementById('btnissues').disabled = true;
        document.getElementById('btnarticles').disabled = true; 
    }

    function prepareForHideMessage(){
        document.getElementById('btndvgetarticles').disabled = false;
        document.getElementById('btnissues').disabled = false;
        document.getElementById('btnarticles').disabled = false; 
        document.getElementById('pleaseWaitMessage').style.display = 'none'; 
    }


    async function downloadArticles(mydata){
        prepareForShowMessage();        
        fetch("http://127.0.0.1:8080/getArticlesForSearchByCountryAndDate", {
        method: "POST",
        headers: {'Content-Type': 'application/json'}, 
        body:JSON.stringify(mydata)
        }).then(response => {
                return response.text();
        }).then(result =>{
            //------------------------------------------ 
            prepareForHideMessage();
            filtersChanged();
            //-------------------------------------------
        });
    }


    function btndvgetarticlesClicked(){
        filterData=getFilterValues();
        downloadArticles(filterData);
    }


    function getIssues(articledid){
        prepareForShowMessage();
        mydata={ArticleID:articledid}
        fetch("http://127.0.0.1:8080/process_content_to_get_issue", {
        method: "POST",
        headers: {'Content-Type': 'application/json'}, 
        body:JSON.stringify(mydata)
        }).then(response => {
                return response.text();
        }).then(result =>{
            //------------------------------------------ 
            prepareForHideMessage();
            filtersChanged();
            //-------------------------------------------
        });       
    }


function assignBadgeLabel(x) {
    // Ensure x is within 0 to 100
    x = Math.max(0, Math.min(100, x));
    // Round x to the nearest 10 to match the badge naming convention
    const roundedX = Math.ceil(x / 10) * 10;
    // Generate the badge label
    const badgeLabel = `badge-${roundedX}`;
    return badgeLabel;
}

function setMessage(theMessage)
{
    document.getElementById('pleaseWaitMessage').innerHTML =theMessage;
}
 
async function fetchRelevantURLsFromWeb(){
        console.log("start fetchRelevantURLsFromWeb()")
        setMessage("Searching Web for Hits")
        mydata=filterData=getFilterValues();
        prepareForShowMessage();
        try{
            fetch("http://127.0.0.1:8080/fetchRelevantURLsFromWeb", {
            method: "POST",
            headers: {'Content-Type': 'application/json'}, 
            body:JSON.stringify(mydata)
            }).then(response => {
                    return response.text();
            }).then(result =>{
                article_id_list=JSON.parse(result);
                if(article_id_list.length==0){
                    setMessage("The Web search returned no hits")
                }else{
                    setMessage(`The Web search returned ${article_id_list.length} hits`);
                }
                console.log("fetchRelevantURLsFromWeb()",article_id_list)
                
                //------------------------------------------ 
                prepareForHideMessage();
                filtersChanged();
                //-------------------------------------------
                console.log("finished fetchRelevantURLsFromWeb()")
                return article_id_list;
            });             
        }catch(err){
                 //------------------------------------------ 
                 prepareForHideMessage();
                 filtersChanged();
                 console.log(err)
                 console.log("failed fetchRelevantURLsFromWeb()")
                //-------------------------------------------           
        }

}

async function fetchArticleContentsFromWeb(article_id_list){
        console.log("Start fetchArticleContentsFromWeb(article_id_list)")
        mydata={savedarticles:article_id_list}
        //setMessage("Fetching Web content...")
        //prepareForShowMessage();
        try{
            fetch("http://127.0.0.1:8080/fetchArticleContentsFromWeb", {
            method: "POST",
            headers: {'Content-Type': 'application/json'}, 
            body:JSON.stringify(mydata)
            }).then(response => {
                    return response.text();
            }).then(result =>{
                article_id_list=JSON.parse(result);
                console.log("fetchArticleContentsFromWeb()",result)
                //setMessage("Finished fetching Web content")
                
                //------------------------------------------ 
                //prepareForHideMessage();
                //filtersChanged();
                //-------------------------------------------
                console.log("finished fetchArticleContentsFromWeb(article_id_list)")
            });             
        }catch(err){
                 //------------------------------------------ 
                 //prepareForHideMessage();
                 //filtersChanged();
                 console.log(err)
                 console.log("Failed fetchArticleContentsFromWeb(article_id_list)")
                //-------------------------------------------           
        }
}

async function determineCountryRelevanceForArticles(article_id_list){
    console.log("Start determineCountryRelevanceForArticles(article_id_list)")
    mydata={savedarticles:article_id_list}
    //setMessage("Determining country that is subject of content...")
    //prepareForShowMessage();
    try{
        fetch("http://127.0.0.1:8080/determineCountryRelevanceForArticles", {
        method: "POST",
        headers: {'Content-Type': 'application/json'}, 
        body:JSON.stringify(mydata)
        }).then(response => {
                return response.text();
        }).then(result =>{
            article_id_list=JSON.parse(result);
            console.log("fetchArticleContentsFromWeb()",result)
            //setMessage("Finished determining country that is subject of content...")
            
            //------------------------------------------ 
            //prepareForHideMessage();
            //filtersChanged();
            //-------------------------------------------
            console.log("finished determineCountryRelevanceForArticles(article_id_list)")

        });             
    }catch(err){
                //------------------------------------------ 
                prepareForHideMessage();
                filtersChanged();
                console.log(err)
                console.log("failed determineCountryRelevanceForArticles(article_id_list)")

            //-------------------------------------------           
    }
}

async function generateSummaryForArticles(article_id_list){
    console.log("start generateSummaryForArticles(article_id_list)")
    mydata={savedarticles:article_id_list}
    //setMessage("Generating summaries...")
    //prepareForShowMessage();
    try{
        fetch("http://127.0.0.1:8080/generateSummaryForArticles", {
        method: "POST",
        headers: {'Content-Type': 'application/json'}, 
        body:JSON.stringify(mydata)
        }).then(response => {
                return response.text();
        }).then(result =>{
            article_id_list=JSON.parse(result);
            //console.log("fetchArticleContentsFromWeb()",result)
            //setMessage("Finished Generating summaries")
            
            //------------------------------------------ 
            //prepareForHideMessage();
            //filtersChanged();
            //-------------------------------------------
            console.log("finished generateSummaryForArticles(article_id_list)")
        });             
    }catch(err){
            //------------------------------------------ 
                //prepareForHideMessage();
                //filtersChanged();
                console.log(err)
                console.log("failed generateSummaryForArticles(article_id_list)")
            //-------------------------------------------           
    }
}

setAllDomainCheckboxes();
function setAllDomainCheckboxes(){
    const checkboxes = document.querySelectorAll('input[type="checkbox"][name="domain"]');
    // Iterate over the NodeList and set each checkbox to checked
    checkboxes.forEach(checkbox => {
    checkbox.checked = true;
});
}
</script>

</body>
</html>
